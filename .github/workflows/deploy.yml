name: Deploy Flask App to Azure VM (Gunicorn + Password Login)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Deploy and Restart Gunicorn
        run: |
          sshpass -p "${{ secrets.AZURE_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.AZURE_USER }}@${{ secrets.AZURE_HOST }} "
            echo '--- Pulling latest code ---'
            cd ~/finalpro || exit 1
            git pull origin main

            echo '--- Activating virtual environment ---'
            source venv/bin/activate

            echo '--- Installing dependencies ---'
            pip install -r requirements.txt

            echo '--- Restarting Gunicorn ---'
            pkill -f gunicorn || true
            nohup gunicorn --bind 127.0.0.1:5000 app:app > gunicorn.log 2>&1 &
            echo 'âœ… Deployment complete and Gunicorn restarted'
          "
